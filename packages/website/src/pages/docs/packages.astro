---
import DocsLayout from '../../layouts/DocsLayout.astro';
import {
  extractSlug,
  formatCategoryLabel,
  getComponents,
  getPackageDetails,
  getPlugins,
  getPresets,
  PLUGIN_CATEGORY_ORDER,
  type PackageEntry
} from '../../lib/registry';

interface ComponentBundle {
  parent: PackageEntry;
  dependencies: string[];
}

interface PresetBundle {
  preset: PackageEntry;
  includes: string[];
}

type PackageKind = 'component' | 'plugin' | 'preset';

const components = getComponents().sort((a, b) => a.title.localeCompare(b.title));
const plugins = getPlugins().sort((a, b) => a.title.localeCompare(b.title));
const presets = getPresets().sort((a, b) => a.title.localeCompare(b.title));

const packageIndex = new Map<string, { entry: PackageEntry; kind: PackageKind }>();
components.forEach((entry) => packageIndex.set(entry.name, { entry, kind: 'component' }));
plugins.forEach((entry) => packageIndex.set(entry.name, { entry, kind: 'plugin' }));
presets.forEach((entry) => packageIndex.set(entry.name, { entry, kind: 'preset' }));

function packageHref(name: string): string | null {
  const target = packageIndex.get(name);
  if (!target) return null;
  const slug = extractSlug(target.entry.path);
  if (target.kind === 'component') return `/components/${slug}`;
  if (target.kind === 'plugin') return `/plugins/${slug}`;
  return `/presets/${slug}`;
}

const componentBundles: ComponentBundle[] = components
  .map((parent) => {
    const manifest = getPackageDetails(parent.path).manifest as { dependencies?: { bloktastic?: string[] } } | null;
    const dependencies = manifest?.dependencies?.bloktastic ?? [];
    return { parent, dependencies };
  })
  .filter((entry) => entry.dependencies.length > 0)
  .sort((a, b) => a.parent.title.localeCompare(b.parent.title));

const presetBundles: PresetBundle[] = presets
  .map((preset) => {
    const manifest = getPackageDetails(preset.path).manifest as { includes?: string[] } | null;
    const includes = manifest?.includes ?? [];
    return { preset, includes };
  })
  .sort((a, b) => a.preset.title.localeCompare(b.preset.title));

const componentGroups = components.reduce<Record<string, PackageEntry[]>>((acc, entry) => {
  const category = entry.category ?? 'uncategorized';
  if (!acc[category]) acc[category] = [];
  acc[category].push(entry);
  return acc;
}, {});

const componentCategoryOrder = ['sections', 'content', 'navigation', 'forms', 'media', 'layout', 'commerce', 'uncategorized'];
const componentCategories = Array.from(new Set([...componentCategoryOrder, ...Object.keys(componentGroups)])).filter(
  (category) => componentGroups[category]?.length
);

const pluginGroups = plugins.reduce<Record<string, PackageEntry[]>>((acc, entry) => {
  const category = entry.category ?? 'uncategorized';
  if (!acc[category]) acc[category] = [];
  acc[category].push(entry);
  return acc;
}, {});

const pluginCategoryOrder = [...PLUGIN_CATEGORY_ORDER, 'uncategorized'];
const pluginCategories = Array.from(new Set([...pluginCategoryOrder, ...Object.keys(pluginGroups)])).filter(
  (category) => pluginGroups[category]?.length
);

const nodeId = (name: string): string => `pkg_${name.replace(/[^a-zA-Z0-9]/g, '_')}`;
const bundleLines = Array.from(
  new Set(
    componentBundles.flatMap((entry) =>
      entry.dependencies.map((dependency) => {
        return `  ${nodeId(entry.parent.name)}["${entry.parent.name}"] --> ${nodeId(dependency)}["${dependency}"]`;
      })
    )
  )
);
const presetLines = Array.from(
  new Set(
    presetBundles.flatMap((entry) =>
      entry.includes.map((dependency) => {
        return `  ${nodeId(entry.preset.name)}["${entry.preset.name}"] --> ${nodeId(dependency)}["${dependency}"]`;
      })
    )
  )
);

const packageGraph = [
  'flowchart LR',
  '  %% Component dependency bundles',
  ...(bundleLines.length ? bundleLines : ['  no_component_bundles["No component dependency bundles"]']),
  '',
  '  %% Preset composition',
  ...(presetLines.length ? presetLines : ['  no_preset_bundles["No preset composition bundles"]'])
].join('\n');

const installFlow = `sequenceDiagram
  participant User
  participant CLI as bloktastic add
  participant Registry
  participant Storyblok
  User->>CLI: add @bloktastic/accordion
  CLI->>Registry: fetch manifest and schema
  CLI->>CLI: resolve dependencies
  CLI->>Registry: fetch @bloktastic/accordion-item
  CLI->>Storyblok: push child schema first
  CLI->>Storyblok: push parent schema
  CLI-->>User: output prompt + complete`;
---

<DocsLayout
  title="Package Catalog"
  description="Complete package documentation for all Bloktastic components, plugins, and presets."
>
  <h1>Package Catalog</h1>

  <p>
    This page is the canonical package documentation for the registry. It is generated from
    <code>registry/registry.json</code> and each package manifest.
  </p>

  <h2>Registry Snapshot</h2>

  <table>
    <thead>
      <tr>
        <th>Package Type</th>
        <th>Count</th>
        <th>Browse</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Components (Bloks)</td>
        <td>{components.length}</td>
        <td><a href="/components">Open components directory</a></td>
      </tr>
      <tr>
        <td>Plugins</td>
        <td>{plugins.length}</td>
        <td><a href="/plugins">Open plugins directory</a></td>
      </tr>
      <tr>
        <td>Presets</td>
        <td>{presets.length}</td>
        <td><a href="/presets">Open presets directory</a></td>
      </tr>
    </tbody>
  </table>

  <h2>Relationship Graphs (Mermaid)</h2>

  <p>
    The graph below shows dependency bundles (component to component) and preset composition (preset to included package).
  </p>

  <pre><code class="language-mermaid">{packageGraph}</code></pre>

  <p>
    Install flow for bundled packages:
  </p>

  <pre><code class="language-mermaid">{installFlow}</code></pre>

  <h2>Component Bundles</h2>

  <p>
    Installing a parent component installs listed dependencies as part of the same operation.
  </p>

  <table>
    <thead>
      <tr>
        <th>Parent Component</th>
        <th>Auto-Installed Dependencies</th>
      </tr>
    </thead>
    <tbody>
      {componentBundles.map((entry) => (
        <tr>
          <td>
            <a href={`/components/${extractSlug(entry.parent.path)}`}><code>{entry.parent.name}</code></a>
          </td>
          <td>
            {entry.dependencies.map((dependency) => {
              const href = packageHref(dependency);
              return href ? <div><a href={href}><code>{dependency}</code></a></div> : <div><code>{dependency}</code></div>;
            })}
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  <h2>Preset Composition</h2>

  <p>
    Presets install a curated set of component packages.
  </p>

  <table>
    <thead>
      <tr>
        <th>Preset</th>
        <th>Included Packages</th>
      </tr>
    </thead>
    <tbody>
      {presetBundles.map((entry) => (
        <tr>
          <td>
            <a href={`/presets/${extractSlug(entry.preset.path)}`}><code>{entry.preset.name}</code></a>
          </td>
          <td>
            {entry.includes.map((included) => {
              const href = packageHref(included);
              return href ? <div><a href={href}><code>{included}</code></a></div> : <div><code>{included}</code></div>;
            })}
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  <h2>Components</h2>

  {componentCategories.map((category) => (
    <section>
      <h3>{formatCategoryLabel(category)} ({componentGroups[category].length})</h3>
      <table>
        <thead>
          <tr>
            <th>Package</th>
            <th>Title</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {componentGroups[category].map((entry) => (
            <tr>
              <td><a href={`/components/${extractSlug(entry.path)}`}><code>{entry.name}</code></a></td>
              <td>{entry.title}</td>
              <td>{entry.description}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </section>
  ))}

  <h2>Plugins</h2>

  {pluginCategories.map((category) => (
    <section>
      <h3>{formatCategoryLabel(category)} ({pluginGroups[category].length})</h3>
      <table>
        <thead>
          <tr>
            <th>Package</th>
            <th>Title</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {pluginGroups[category].map((entry) => (
            <tr>
              <td><a href={`/plugins/${extractSlug(entry.path)}`}><code>{entry.name}</code></a></td>
              <td>{entry.title}</td>
              <td>{entry.description}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </section>
  ))}

  <h2>Presets</h2>

  <table>
    <thead>
      <tr>
        <th>Package</th>
        <th>Title</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      {presets.map((entry) => (
        <tr>
          <td><a href={`/presets/${extractSlug(entry.path)}`}><code>{entry.name}</code></a></td>
          <td>{entry.title}</td>
          <td>{entry.description}</td>
        </tr>
      ))}
    </tbody>
  </table>

  <h2>CLI Discovery</h2>

  <pre><code>bloktastic list --type component
bloktastic list --type plugin
bloktastic list --type preset
bloktastic info @bloktastic/accordion</code></pre>

  <script type="module" is:inline>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

    const blocks = Array.from(document.querySelectorAll('pre > code.language-mermaid'));
    if (!blocks.length) return;

    mermaid.initialize({
      startOnLoad: false,
      theme: 'neutral',
      securityLevel: 'loose'
    });

    for (const block of blocks) {
      const pre = block.parentElement;
      if (!pre || !pre.parentElement) continue;
      const wrapper = document.createElement('div');
      wrapper.className = 'mermaid';
      wrapper.textContent = block.textContent ?? '';
      pre.replaceWith(wrapper);
    }

    mermaid.run();
  </script>
</DocsLayout>
