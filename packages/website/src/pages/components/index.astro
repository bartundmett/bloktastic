---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PackageCard from '../../components/PackageCard.astro';
import { extractSlug, formatCategoryLabel, getComponents, getPresets } from '../../lib/registry';

const components = getComponents().sort((a, b) => a.title.localeCompare(b.title));
const presets = getPresets().sort((a, b) => a.title.localeCompare(b.title));

const groupedComponents = components.reduce<Record<string, typeof components>>((acc, item) => {
  const category = item.category ?? 'uncategorized';
  if (!acc[category]) acc[category] = [];
  acc[category].push(item);
  return acc;
}, {});

const categories = Object.keys(groupedComponents).sort((a, b) => a.localeCompare(b));

const tagCounts = new Map<string, number>();
for (const entry of [...components, ...presets]) {
  for (const tag of entry.tags ?? []) {
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
  }
}
const filterTags = Array.from(tagCounts.entries())
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
  .slice(0, 16);
---

<BaseLayout
  title="Bloks & Presets"
  description="Browse Storyblok components and preset packs from the Bloktastic registry with filterable directory controls."
>
  <section class="container-shell py-12">
    <header class="mb-10 max-w-3xl">
      <p class="mb-3 inline-flex rounded-full bg-paper px-4 py-2 text-xs font-bold uppercase tracking-[0.14em] text-slate-600">
        Directory
      </p>
      <h1 class="font-display text-4xl font-extrabold text-graphite lg:text-5xl">Bloks & Presets</h1>
      <p class="mt-3 text-lg text-slate-600">
        Shopware-style browsing with persistent filters. Find single bloks or full preset packs from one directory.
      </p>
    </header>

    <div class="grid gap-8 lg:grid-cols-[290px_minmax(0,1fr)]">
      <aside class="lg:sticky lg:top-28 lg:h-fit">
        <div class="glass-card space-y-6 p-5">
          <div>
            <p class="text-xs font-bold uppercase tracking-[0.12em] text-slate-500">Results</p>
            <p id="directory-results-count" class="mt-1 text-2xl font-black text-graphite">{components.length + presets.length}</p>
          </div>

          <label class="block">
            <span class="mb-2 block text-xs font-bold uppercase tracking-[0.12em] text-slate-500">Search</span>
            <input
              id="directory-search"
              type="search"
              placeholder="Name, title, or tag"
              class="w-full rounded-xl border border-borderline bg-white px-3 py-2 text-sm text-graphite outline-none ring-intelligence/30 transition focus:ring"
            />
          </label>

          <section>
            <h2 class="mb-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-500">Package Type</h2>
            <div class="space-y-2 text-sm">
              <label class="flex items-center justify-between gap-3">
                <span class="inline-flex items-center gap-2 text-slate-700">
                  <input type="checkbox" name="kind-filter" value="component" checked class="rounded border-borderline" />
                  Bloks
                </span>
                <span class="rounded bg-paper px-2 py-0.5 text-xs font-bold text-slate-600">{components.length}</span>
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="inline-flex items-center gap-2 text-slate-700">
                  <input type="checkbox" name="kind-filter" value="preset" checked class="rounded border-borderline" />
                  Presets
                </span>
                <span class="rounded bg-paper px-2 py-0.5 text-xs font-bold text-slate-600">{presets.length}</span>
              </label>
            </div>
          </section>

          <section>
            <h2 class="mb-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-500">Blok Categories</h2>
            <div class="max-h-48 space-y-2 overflow-auto pr-1 text-sm">
              {categories.map((category) => (
                <label class="flex items-center justify-between gap-3">
                  <span class="inline-flex items-center gap-2 text-slate-700">
                    <input
                      type="checkbox"
                      name="component-category-filter"
                      value={category}
                      class="rounded border-borderline"
                    />
                    {formatCategoryLabel(category)}
                  </span>
                  <span class="rounded bg-paper px-2 py-0.5 text-xs font-bold text-slate-600">{groupedComponents[category].length}</span>
                </label>
              ))}
            </div>
          </section>

          <section>
            <h2 class="mb-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-500">Popular Tags</h2>
            <div class="max-h-52 space-y-2 overflow-auto pr-1 text-sm">
              {filterTags.map(([tag, count]) => (
                <label class="flex items-center justify-between gap-3">
                  <span class="inline-flex items-center gap-2 text-slate-700">
                    <input type="checkbox" name="tag-filter" value={tag} class="rounded border-borderline" />
                    #{tag}
                  </span>
                  <span class="rounded bg-paper px-2 py-0.5 text-xs font-bold text-slate-600">{count}</span>
                </label>
              ))}
            </div>
          </section>

          <button id="directory-reset" type="button" class="btn-secondary w-full">Reset Filters</button>
        </div>
      </aside>

      <div>
        <div id="directory-sections" class="space-y-12">
          <section id="preset-section" class="directory-section" data-section-kind="preset">
            <header class="mb-5 flex items-end justify-between gap-3">
              <div>
                <h2 class="font-display text-3xl font-bold text-graphite">Preset Packs</h2>
                <p class="mt-1 text-sm text-slate-600">Ready-made bundles for landing pages, blogs, and growth sites.</p>
              </div>
              <p class="rounded-full bg-paper px-3 py-1 text-xs font-bold uppercase tracking-[0.12em] text-slate-500">
                <span class="section-count">{presets.length}</span> packages
              </p>
            </header>
            <div class="grid gap-5 sm:grid-cols-2 xl:grid-cols-3">
              {presets.map((entry) => (
                <div
                  class="directory-item"
                  data-kind="preset"
                  data-category="preset"
                  data-name={entry.name.toLowerCase()}
                  data-title={entry.title.toLowerCase()}
                  data-tags={(entry.tags ?? []).join('|').toLowerCase()}
                >
                  <PackageCard entry={entry} href={`/presets/${extractSlug(entry.path)}`} kind="preset" />
                </div>
              ))}
            </div>
          </section>

          {categories.map((category) => (
            <section id={`components-${category}`} class="directory-section" data-section-kind="component" data-category={category}>
              <header class="mb-5 flex items-end justify-between gap-3">
                <div>
                  <h2 class="font-display text-3xl font-bold text-graphite">{formatCategoryLabel(category)}</h2>
                  <p class="mt-1 text-sm text-slate-600">Bloks in the {formatCategoryLabel(category).toLowerCase()} family.</p>
                </div>
                <p class="rounded-full bg-paper px-3 py-1 text-xs font-bold uppercase tracking-[0.12em] text-slate-500">
                  <span class="section-count">{groupedComponents[category].length}</span> bloks
                </p>
              </header>

              <div class="grid gap-5 sm:grid-cols-2 xl:grid-cols-3">
                {groupedComponents[category].map((entry) => (
                  <div
                    class="directory-item"
                    data-kind="component"
                    data-category={category}
                    data-name={entry.name.toLowerCase()}
                    data-title={entry.title.toLowerCase()}
                    data-tags={(entry.tags ?? []).join('|').toLowerCase()}
                  >
                    <PackageCard entry={entry} href={`/components/${extractSlug(entry.path)}`} kind="component" />
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>

        <div id="directory-empty-state" class="hidden glass-card py-14 text-center text-slate-500">
          No bloks or presets match your filters.
        </div>
      </div>
    </div>
  </section>

  <script>
    const searchInput = document.getElementById('directory-search');
    const resetButton = document.getElementById('directory-reset');
    const resultCount = document.getElementById('directory-results-count');
    const emptyState = document.getElementById('directory-empty-state');
    const sections = Array.from(document.querySelectorAll('.directory-section'));
    const items = Array.from(document.querySelectorAll('.directory-item'));
    const kindInputs = Array.from(document.querySelectorAll('input[name="kind-filter"]'));
    const categoryInputs = Array.from(document.querySelectorAll('input[name="component-category-filter"]'));
    const tagInputs = Array.from(document.querySelectorAll('input[name="tag-filter"]'));

    const selectedValues = (inputs: Element[]) =>
      new Set(
        inputs
          .filter((input: Element): input is HTMLInputElement => input instanceof HTMLInputElement && input.checked)
          .map((input: HTMLInputElement) => input.value)
      );

    const applyFilters = () => {
      const query = searchInput instanceof HTMLInputElement ? searchInput.value.toLowerCase().trim() : '';
      const selectedKinds = selectedValues(kindInputs);
      const selectedCategories = selectedValues(categoryInputs);
      const selectedTags = selectedValues(tagInputs);

      items.forEach((item) => {
        const kind = item.getAttribute('data-kind') || '';
        const category = item.getAttribute('data-category') || '';
        const name = item.getAttribute('data-name') || '';
        const title = item.getAttribute('data-title') || '';
        const tags = (item.getAttribute('data-tags') || '').split('|').filter(Boolean);

        const kindMatches = selectedKinds.size === 0 || selectedKinds.has(kind);
        const categoryMatches =
          kind !== 'component' || selectedCategories.size === 0 || selectedCategories.has(category);
        const tagMatches = selectedTags.size === 0 || tags.some((tag) => selectedTags.has(tag));
        const queryMatches = !query || name.includes(query) || title.includes(query) || tags.some((tag) => tag.includes(query));

        item.classList.toggle('hidden', !(kindMatches && categoryMatches && tagMatches && queryMatches));
      });

      let visibleTotal = 0;
      sections.forEach((section) => {
        const visibleInSection = section.querySelectorAll('.directory-item:not(.hidden)').length;
        const badge = section.querySelector('.section-count');
        if (badge) badge.textContent = String(visibleInSection);
        section.classList.toggle('hidden', visibleInSection === 0);
        visibleTotal += visibleInSection;
      });

      if (resultCount) resultCount.textContent = String(visibleTotal);
      if (emptyState) emptyState.classList.toggle('hidden', visibleTotal > 0);
    };

    searchInput?.addEventListener('input', applyFilters);
    kindInputs.forEach((input) => input.addEventListener('change', applyFilters));
    categoryInputs.forEach((input) => input.addEventListener('change', applyFilters));
    tagInputs.forEach((input) => input.addEventListener('change', applyFilters));

    resetButton?.addEventListener('click', () => {
      if (searchInput instanceof HTMLInputElement) searchInput.value = '';
      kindInputs.forEach((input) => {
        if (input instanceof HTMLInputElement) input.checked = true;
      });
      categoryInputs.forEach((input) => {
        if (input instanceof HTMLInputElement) input.checked = false;
      });
      tagInputs.forEach((input) => {
        if (input instanceof HTMLInputElement) input.checked = false;
      });
      applyFilters();
    });
  </script>
</BaseLayout>
